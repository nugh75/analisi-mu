{% extends "base.html" %}

{% block title %}Esporta Diario - Diario di Bordo{% endblock %}

{% block extra_css %}
<style>
.export-option {
    transition: all 0.3s ease;
    cursor: pointer;
    border: 2px solid transparent;
}

.export-option:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.format-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.filter-section {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.export-preview {
    max-height: 200px;
    overflow-y: auto;
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 15px;
    font-family: monospace;
    font-size: 0.9em;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="bi bi-download me-2"></i>Esporta Diario di Bordo</h1>
                <a href="{{ url_for('diary.index') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Torna al Diario
                </a>
            </div>
        </div>
    </div>

    <!-- Sezione filtri -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="filter-section">
                <h4 class="mb-3"><i class="bi bi-funnel me-2"></i>Filtri per l'Esportazione</h4>
                <form id="exportFilters">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="start_date" class="form-label">Data Inizio</label>
                            <input type="date" class="form-control" id="start_date" name="start_date">
                        </div>
                        <div class="col-md-3">
                            <label for="end_date" class="form-label">Data Fine</label>
                            <input type="date" class="form-control" id="end_date" name="end_date">
                        </div>
                        <div class="col-md-2">
                            <label for="activity_type" class="form-label">Tipo Attività</label>
                            <select class="form-select" id="activity_type" name="activity_type">
                                <option value="all">Tutti</option>
                                <option value="general">Generale</option>
                                <option value="meeting">Riunione</option>
                                <option value="milestone">Milestone</option>
                                <option value="issue">Problema</option>
                                <option value="decision">Decisione</option>
                                <option value="reflection">Riflessione</option>
                                <option value="consideration">Considerazione</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="priority" class="form-label">Priorità</label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="all">Tutte</option>
                                <option value="low">Bassa</option>
                                <option value="medium">Media</option>
                                <option value="high">Alta</option>
                                <option value="urgent">Urgente</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="all">Tutti</option>
                                <option value="active">Attivo</option>
                                <option value="completed">Completato</option>
                                <option value="archived">Archiviato</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="button" class="btn btn-outline-primary" onclick="previewExport()">
                                <i class="bi bi-eye me-1"></i>Anteprima
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetFilters()">
                                <i class="bi bi-x-lg me-1"></i>Reset Filtri
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Anteprima risultati -->
    <div class="row mb-4" id="previewSection" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Anteprima Esportazione</h5>
                </div>
                <div class="card-body">
                    <div id="previewContent" class="export-preview">
                        <!-- Contenuto anteprima verrà inserito qui -->
                    </div>
                    <div class="mt-3">
                        <span id="previewStats" class="text-muted"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Opzioni di esportazione -->
    <div class="row">
        <div class="col-12">
            <h4 class="mb-4"><i class="bi bi-file-earmark-arrow-down me-2"></i>Scegli Formato di Esportazione</h4>
        </div>
    </div>

    <div class="row g-4">
        <!-- Esportazione TXT -->
        <div class="col-md-4">
            <div class="card export-option h-100" onclick="exportFormat('txt')">
                <div class="card-body text-center">
                    <i class="bi bi-file-earmark-text format-icon text-primary"></i>
                    <h5 class="card-title">Testo Semplice (TXT)</h5>
                    <p class="card-text">
                        Esporta il diario in formato testo semplice, ideale per la lettura e per essere utilizzato in qualsiasi editor di testo.
                    </p>
                    <div class="mt-auto">
                        <span class="badge bg-primary">✓ Sempre disponibile</span>
                        <span class="badge bg-info">✓ Leggero</span>
                        <span class="badge bg-success">✓ Compatibile</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Esportazione Word -->
        <div class="col-md-4">
            <div class="card export-option h-100" onclick="exportFormat('word')">
                <div class="card-body text-center">
                    <i class="bi bi-file-earmark-word format-icon text-primary"></i>
                    <h5 class="card-title">Microsoft Word (DOCX)</h5>
                    <p class="card-text">
                        Esporta in formato Word con formattazione professionale, tabelle per i metadati e struttura organizzata.
                    </p>
                    <div class="mt-auto">
                        <span class="badge bg-primary">✓ Formattazione ricca</span>
                        <span class="badge bg-info">✓ Tabelle</span>
                        <span class="badge bg-success">✓ Professionale</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Esportazione PDF -->
        <div class="col-md-4">
            <div class="card export-option h-100" onclick="exportFormat('pdf')">
                <div class="card-body text-center">
                    <i class="bi bi-file-earmark-pdf format-icon text-danger"></i>
                    <h5 class="card-title">Adobe PDF</h5>
                    <p class="card-text">
                        Esporta in formato PDF con layout professionale, ideale per archiviazione e condivisione formale.
                    </p>
                    <div class="mt-auto">
                        <span class="badge bg-danger">✓ Layout fisso</span>
                        <span class="badge bg-info">✓ Archiviazione</span>
                        <span class="badge bg-success">✓ Universale</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informazioni aggiuntive -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h5><i class="bi bi-info-circle me-2"></i>Informazioni sui Formati</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <h6>TXT - Testo Semplice</h6>
                            <ul class="small">
                                <li>Dimensione file ridotta</li>
                                <li>Compatibile con tutti i sistemi</li>
                                <li>Facile da elaborare programmaticamente</li>
                                <li>Include tutti i metadati e allegati</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>DOCX - Microsoft Word</h6>
                            <ul class="small">
                                <li>Formattazione ricca e professionale</li>
                                <li>Tabelle per organizzare i metadati</li>
                                <li>Facilmente modificabile</li>
                                <li>Standard per documenti aziendali</li>
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <h6>PDF - Portable Document</h6>
                            <ul class="small">
                                <li>Layout fisso e professionale</li>
                                <li>Ideale per archiviazione</li>
                                <li>Non modificabile facilmente</li>
                                <li>Universalmente supportato</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getFilterParams() {
    const form = document.getElementById('exportFilters');
    const formData = new FormData(form);
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        if (value) {
            params.append(key, value);
        }
    }
    
    return params;
}

function exportFormat(format) {
    const params = getFilterParams();
    const url = `{{ url_for('diary.export_txt') }}`.replace('txt', format) + '?' + params.toString();
    
    // Mostra un messaggio di loading
    const originalText = event.target.innerHTML;
    const card = event.target.closest('.card');
    card.style.opacity = '0.7';
    
    // Crea un link temporaneo per il download
    const link = document.createElement('a');
    link.href = url;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Ripristina l'aspetto dopo un breve delay
    setTimeout(() => {
        card.style.opacity = '1';
    }, 1000);
}

function previewExport() {
    const params = getFilterParams();
    
    // Simula una chiamata per ottenere l'anteprima
    // In una implementazione reale, faresti una chiamata AJAX
    const previewSection = document.getElementById('previewSection');
    const previewContent = document.getElementById('previewContent');
    const previewStats = document.getElementById('previewStats');
    
    // Mostra la sezione anteprima
    previewSection.style.display = 'block';
    
    // Esempio di contenuto anteprima
    previewContent.innerHTML = `
DIARIO DI BORDO
==================================================
Esportato il: ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}
Filtri applicati: ${params.toString() || 'Nessun filtro'}

--------------------------------------------------
ESEMPIO VOCE DIARIO
TITOLO: Implementazione Sistema Etichettatura
AUTORE: ${document.querySelector('meta[name="current-user"]')?.content || 'utente'}
DATA: ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}
TIPO: MILESTONE
PRIORITÀ: HIGH
STATUS: ACTIVE

CONTENUTO:
Completata l'implementazione del nuovo sistema di etichettatura.
Sono stati coinvolti @mario e @laura per i test.
I file modificati includono #models.py e #routes/labels.py

UTENTI MENZIONATI: @mario, @laura
FILE REFERENZIATI: #models.py, #routes/labels.py
--------------------------------------------------
    `;
    
    previewStats.textContent = `Filtri applicati: ${params.toString() || 'Nessun filtro'} | Voci che verranno esportate: [Calcolo in corso...]`;
    
    // Scorri fino all'anteprima
    previewSection.scrollIntoView({ behavior: 'smooth' });
}

function resetFilters() {
    document.getElementById('exportFilters').reset();
    document.getElementById('previewSection').style.display = 'none';
}

// Imposta la data di fine al giorno corrente
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('end_date').value = today;
    
    // Imposta la data di inizio a 30 giorni fa
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById('start_date').value = thirtyDaysAgo.toISOString().split('T')[0];
});
</script>
{% endblock %}
