<form method="post" action="{{ url_for('projects.update_collaborators', project_id=project.id) }}" class="small">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
  <input type="hidden" name="redirect" value="{{ redirect_target }}"/>
  <div class="mb-2 text-muted">Seleziona gli utenti che possono accedere e il relativo ruolo (il proprietario Ã¨ incluso automaticamente).</div>
  <div class="row row-cols-1 row-cols-md-2 g-2">
    {% for user in users %}
      {% if user.id != project.owner_id %}
      <div class="col">
        <div class="d-flex align-items-center justify-content-between border rounded p-2">
          <div class="form-check">
            <input class="form-check-input collab-check" type="checkbox" name="collaborators[]" id="collab_{{ user.id }}" value="{{ user.id }}" {% if user.id in selected_ids %}checked{% endif %}>
            <label class="form-check-label" for="collab_{{ user.id }}">{{ user.username }}</label>
          </div>
          <div>
            <select class="form-select form-select-sm collab-role" name="role_{{ user.id }}" {% if user.id not in selected_ids %}disabled{% endif %}>
              {% set r = roles_map.get(user.id, 'viewer') %}
              <option value="viewer" {% if r=='viewer' %}selected{% endif %}>Visualizzatore</option>
              <option value="annotator" {% if r=='annotator' %}selected{% endif %}>Annotatore</option>
              <option value="editor" {% if r=='editor' %}selected{% endif %}>Editor</option>
              <option value="moderator" {% if r=='moderator' %}selected{% endif %}>Moderatore</option>
            </select>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>
  <div class="d-flex justify-content-end mt-3">
    <button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-save me-1"></i>Salva Collaboratori</button>
  </div>

  <script>
    (function(){
      document.querySelectorAll('.collab-check').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const sel = e.target.closest('.d-flex').querySelector('.collab-role');
          if (sel) sel.disabled = !e.target.checked;
        });
      });
    })();
  </script>
</form>
