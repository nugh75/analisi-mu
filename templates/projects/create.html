{% extends "base.html" %}

{% block title %}Crea Nuovo Progetto - Anatema{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="mb-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('projects.list_projects') }}">
                                <i class="bi bi-folder me-1"></i>Progetti
                            </a>
                        </li>
                        <li class="breadcrumb-item active">Nuovo Progetto</li>
                    </ol>
                </nav>
                
                <h2>
                    <i class="bi bi-plus-circle me-2"></i>Crea Nuovo Progetto
                </h2>
                <p class="text-muted">
                    Organizza file Excel e documenti di testo in un progetto per l'analisi collaborativa
                </p>
            </div>

            <div class="card">
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <!-- Informazioni Base -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-info-circle me-2"></i>Informazioni di Base
                                </h5>
                            </div>
                            
                            <div class="col-md-8">
                                <div class="mb-3">
                                    {{ form.name.label(class="form-label") }}
                                    <span class="text-danger">*</span>
                                    {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                                    {% if form.name.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.name.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.project_type.label(class="form-label") }}
                                    <span class="text-danger">*</span>
                                    {{ form.project_type(class="form-select" + (" is-invalid" if form.project_type.errors else "")) }}
                                    {% if form.project_type.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.project_type.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.description.label(class="form-label") }}
                                    {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else "")) }}
                                    {% if form.description.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.description.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Descrizione generale del progetto e dei suoi obiettivi</div>
                                </div>
                            </div>
                        </div>

                        <!-- Obiettivi e Metodologia -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-target me-2"></i>Obiettivi e Metodologia
                                </h5>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.objectives.label(class="form-label") }}
                                    {{ form.objectives(class="form-control" + (" is-invalid" if form.objectives.errors else "")) }}
                                    {% if form.objectives.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.objectives.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Obiettivi specifici e risultati attesi</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.methodology.label(class="form-label") }}
                                    {{ form.methodology(class="form-control" + (" is-invalid" if form.methodology.errors else "")) }}
                                    {% if form.methodology.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.methodology.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Metodologia di ricerca o approccio analitico</div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="mb-3">
                                    {{ form.tags.label(class="form-label") }}
                                    {{ form.tags(class="form-control" + (" is-invalid" if form.tags.errors else "")) }}
                                    {% if form.tags.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.tags.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Tag per organizzare e filtrare i progetti (separati da virgola)</div>
                                </div>
                            </div>
                        </div>

                        <!-- Configurazioni -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-gear me-2"></i>Configurazioni
                                </h5>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.visibility.label(class="form-label") }}
                                    {{ form.visibility(class="form-select" + (" is-invalid" if form.visibility.errors else "")) }}
                                    {% if form.visibility.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.visibility.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Controlla chi può visualizzare il progetto</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.default_annotation_mode.label(class="form-label") }}
                                    {{ form.default_annotation_mode(class="form-select" + (" is-invalid" if form.default_annotation_mode.errors else "")) }}
                                    {% if form.default_annotation_mode.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.default_annotation_mode.errors %}{{ error }}{% endfor %}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">Modalità predefinita per le annotazioni</div>
                                </div>
                            </div>
                        </div>

                        <!-- Opzioni Avanzate -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-sliders me-2"></i>Opzioni Avanzate
                                </h5>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    {{ form.enable_ai_assistance(class="form-check-input") }}
                                    {{ form.enable_ai_assistance.label(class="form-check-label") }}
                                    <div class="form-text">Abilita suggerimenti AI per le annotazioni</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    {{ form.auto_assign_collaborators(class="form-check-input") }}
                                    {{ form.auto_assign_collaborators.label(class="form-check-label") }}
                                    <div class="form-text">Assegna automaticamente i nuovi file ai collaboratori</div>
                                </div>
                            </div>
                        </div>

                        <!-- Pulsanti -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <a href="{{ url_for('projects.list_projects') }}" class="btn btn-secondary me-md-2">
                                        <i class="bi bi-x-circle me-1"></i>Annulla
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle me-1"></i>Crea Progetto
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Pannello laterale con suggerimenti -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-lightbulb me-1"></i>Suggerimenti
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>🎯 Tipi di Progetto</h6>
                        <ul class="small">
                            <li><strong>Misto:</strong> Combina file Excel e documenti di testo</li>
                            <li><strong>Solo Excel:</strong> Analisi di questionari strutturati</li>
                            <li><strong>Solo Testo:</strong> Analisi qualitativa di interviste/focus group</li>
                            <li><strong>Questionario:</strong> Survey con domande specifiche</li>
                            <li><strong>Ricerca:</strong> Studi qualitativi approfonditi</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <h6>👥 Modalità Annotazione</h6>
                        <ul class="small">
                            <li><strong>Collaborativa:</strong> Tutti possono vedere e modificare</li>
                            <li><strong>Indipendente:</strong> Ogni annotatore lavora separatamente</li>
                            <li><strong>Con Revisione:</strong> Le annotazioni richiedono approvazione</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <h6>🔒 Visibilità</h6>
                        <ul class="small">
                            <li><strong>Privato:</strong> Solo proprietario e collaboratori invitati</li>
                            <li><strong>Team:</strong> Tutti i membri del tuo team</li>
                            <li><strong>Pubblico:</strong> Tutti gli utenti della piattaforma</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-info">
                        <small>
                            <i class="bi bi-info-circle me-1"></i>
                            Dopo la creazione potrai aggiungere file, invitare collaboratori e configurare etichette personalizzate.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Aggiorna automaticamente il placeholder della descrizione in base al tipo
document.getElementById('project_type').addEventListener('change', function() {
    const descriptionField = document.getElementById('description');
    const placeholders = {
        'mixed': 'Progetto che combina file Excel e documenti di testo per un\'analisi completa e multi-dimensionale...',
        'excel_only': 'Analisi di dati quantitativi e risposte strutturate da questionari Excel...',
        'text_only': 'Analisi qualitativa di interviste, focus group o documenti testuali...',
        'survey': 'Analisi di un questionario specifico con domande chiuse e aperte...',
        'research': 'Studio di ricerca qualitativa con metodologia strutturata...'
    };
    
    descriptionField.placeholder = placeholders[this.value] || 'Descrizione del progetto...';
});

// Validazione in tempo reale per il nome progetto
document.getElementById('name').addEventListener('input', function() {
    const value = this.value.trim();
    const feedback = this.parentNode.querySelector('.invalid-feedback');
    
    if (value.length < 3) {
        this.classList.add('is-invalid');
        if (!feedback) {
            const div = document.createElement('div');
            div.className = 'invalid-feedback';
            div.textContent = 'Il nome deve essere di almeno 3 caratteri';
            this.parentNode.appendChild(div);
        } else {
            feedback.textContent = 'Il nome deve essere di almeno 3 caratteri';
        }
    } else {
        this.classList.remove('is-invalid');
        if (feedback) {
            feedback.remove();
        }
    }
});

// Preview dei tag mentre si digita
document.getElementById('tags').addEventListener('input', function() {
    const value = this.value.trim();
    let preview = this.parentNode.querySelector('.tag-preview');
    
    if (!preview) {
        preview = document.createElement('div');
        preview.className = 'tag-preview mt-1';
        this.parentNode.appendChild(preview);
    }
    
    if (value) {
        const tags = value.split(',').map(tag => tag.trim()).filter(tag => tag);
        preview.innerHTML = tags.map(tag => 
            `<span class="badge bg-light text-dark me-1">${tag}</span>`
        ).join('');
    } else {
        preview.innerHTML = '';
    }
});
</script>
{% endblock %}
