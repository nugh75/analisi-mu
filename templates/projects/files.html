{% extends "base.html" %}

{% block title %}File - {{ project.name }}{% endblock %}

{% block content %}
<div class="row mb-3">
	<div class="col-12 d-flex justify-content-between align-items-center">
		<div>
			<h2><i class="bi bi-files me-2"></i>File di {{ project.name }}</h2>
			<p class="text-muted mb-0">Vista unificata di file Excel e Documenti di Testo</p>
		</div>
			<div class="btn-group">
			<a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-outline-secondary">
				<i class="bi bi-speedometer2 me-1"></i>Dashboard
			</a>
			<a href="{{ url_for('projects.project_notes', project_id=project.id) }}" class="btn btn-outline-secondary">
				<i class="bi bi-sticky me-1"></i>Note
			</a>
			<a href="{{ url_for('projects.manage_collaborators', project_id=project.id) }}" class="btn btn-outline-secondary">
				<i class="bi bi-people me-1"></i>Collaboratori
			</a>
			{% if project.can_manage(current_user) %}
			<a href="{{ url_for('projects.project_settings', project_id=project.id) }}" class="btn btn-outline-warning">
				<i class="bi bi-gear me-1"></i>Impostazioni
			</a>
			{% endif %}
		</div>
	</div>
</div>

<!-- Filtri -->
<form method="get" class="row g-3 mb-3">
	<div class="col-md-3">
		<label class="form-label">Tipo</label>
		<select class="form-select" name="type">
			<option value="all" {{ 'selected' if file_type=='all' else '' }}>Tutti</option>
			<option value="excel" {{ 'selected' if file_type=='excel' else '' }}>Excel</option>
			<option value="text" {{ 'selected' if file_type=='text' else '' }}>Testo</option>
		</select>
	</div>
	<div class="col-md-3">
		<label class="form-label">Ordina per</label>
		<select class="form-select" name="sort">
			<option value="date" {{ 'selected' if sort_by=='date' else '' }}>Data</option>
			<option value="name" {{ 'selected' if sort_by=='name' else '' }}>Nome</option>
			<option value="annotations" {{ 'selected' if sort_by=='annotations' else '' }}>Annotazioni</option>
		</select>
	</div>
	<div class="col-md-3 d-flex align-items-end">
		<button type="submit" class="btn btn-primary w-100"><i class="bi bi-search me-1"></i>Applica</button>
	</div>
</form>

{% if files.items %}
<div class="table-responsive">
	<table class="table table-hover align-middle">
		<thead>
			<tr>
				<th style="width:40px;"></th>
				<th>Nome</th>
				<th>Tipo</th>
				<th>Annotazioni</th>
				<th>Elementi</th>
				<th>Caricato da</th>
				<th>Data</th>
				<th>Azioni</th>
			</tr>
		</thead>
		<tbody>
			{% for f in files.items %}
			<tr>
				<td class="text-center">
					{% if f.type == 'excel' %}
					<i class="bi bi-file-earmark-excel text-success"></i>
					{% else %}
					<i class="bi bi-file-text text-primary"></i>
					{% endif %}
				</td>
				<td>{{ f.name }}</td>
				<td class="text-capitalize">{{ f.type }}</td>
				<td>{{ f.annotations_count }}</td>
				<td>{{ f.cells_count }}</td>
				<td>{{ f.uploader }}</td>
				<td>
					{% if f.uploaded_at %}
					<small class="text-muted">{{ f.uploaded_at.strftime('%d/%m/%Y %H:%M') }}</small>
					{% endif %}
				</td>
				<td>
					{% if f.type == 'excel' %}
					<a href="{{ url_for('excel.view_file', file_id=f.id) }}" class="btn btn-sm btn-outline-primary">
						<i class="bi bi-eye me-1"></i>Apri
					</a>
					{% else %}
					<a href="{{ url_for('text_documents.annotate', document_id=f.id) }}" class="btn btn-sm btn-outline-primary">
						<i class="bi bi-eye me-1"></i>Apri
					</a>
					{% endif %}
					{% if project.can_edit(current_user) %}
					<form method="post" action="{{ url_for('projects.unassign_file', project_id=project.id, file_type=f.type, file_id=f.id, type=file_type, sort=sort_by, page=files.page) }}" class="d-inline ms-1" onsubmit="return confirm('Rimuovere questo file dal progetto?');">
						<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
						<button type="submit" class="btn btn-sm btn-outline-danger">
							<i class="bi bi-x-circle me-1"></i>Rimuovi
						</button>
					</form>
					{% endif %}
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</div>

<!-- Paginazione -->
{% if files.pages > 1 %}
<nav aria-label="Paginazione" class="mt-3">
	<ul class="pagination justify-content-center">
		{% if files.has_prev %}
		<li class="page-item">
			<a class="page-link" href="{{ url_for('projects.project_files', project_id=project.id, page=files.prev_num, type=file_type, sort=sort_by) }}">
				<i class="bi bi-chevron-left"></i>
			</a>
		</li>
		{% endif %}

		{% for p in range(1, files.pages + 1) %}
		<li class="page-item {{ 'active' if p == files.page else '' }}">
			<a class="page-link" href="{{ url_for('projects.project_files', project_id=project.id, page=p, type=file_type, sort=sort_by) }}">{{ p }}</a>
		</li>
		{% endfor %}

		{% if files.has_next %}
		<li class="page-item">
			<a class="page-link" href="{{ url_for('projects.project_files', project_id=project.id, page=files.next_num, type=file_type, sort=sort_by) }}">
				<i class="bi bi-chevron-right"></i>
			</a>
		</li>
		{% endif %}
	</ul>
	<div class="text-center text-muted small">Totale: {{ files.total }}</div>
 </nav>
{% endif %}

{% else %}
<div class="text-center py-5">
	<i class="bi bi-folder2-open display-1 text-muted mb-3"></i>
	<h5 class="text-muted">Nessun file</h5>
	<p class="text-muted">Carica file Excel o documenti di testo in questo progetto.</p>
</div>
{% endif %}

{% if project.can_edit(current_user) %}
<!-- Barra azioni -->
<div class="d-flex justify-content-end mt-3">
		<button id="btn-open-assign" class="btn btn-primary">
				<i class="bi bi-plus-circle me-1"></i> Assegna file al progetto
		</button>
		<input type="hidden" id="csrf_token" value="{{ csrf_token() }}"/>
		<input type="hidden" id="project_id" value="{{ project.id }}"/>
</div>

<!-- Modale assegnazione -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Assegna file a {{ project.name }}</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<ul class="nav nav-tabs" role="tablist">
					<li class="nav-item" role="presentation">
						<button class="nav-link active" id="tab-excel" data-bs-toggle="tab" data-bs-target="#pane-excel" type="button" role="tab">Excel</button>
					</li>
					<li class="nav-item" role="presentation">
						<button class="nav-link" id="tab-text" data-bs-toggle="tab" data-bs-target="#pane-text" type="button" role="tab">Documenti</button>
					</li>
				</ul>
				<div class="tab-content mt-3">
					<div class="tab-pane fade show active" id="pane-excel" role="tabpanel">
						<div id="excel-list" class="list-group small"></div>
					</div>
					<div class="tab-pane fade" id="pane-text" role="tabpanel">
						<div id="text-list" class="list-group small"></div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
				<button type="button" id="btn-assign-confirm" class="btn btn-primary">
					<i class="bi bi-check-circle me-1"></i> Assegna selezionati
				</button>
			</div>
		</div>
	</div>
	</div>

<script>
	(function() {
		const btnOpen = document.getElementById('btn-open-assign');
		const modalEl = document.getElementById('assignModal');
		const excelList = document.getElementById('excel-list');
		const textList = document.getElementById('text-list');
		const btnConfirm = document.getElementById('btn-assign-confirm');
		const projectId = document.getElementById('project_id').value;
		const csrf = document.getElementById('csrf_token').value;

		function renderItems(container, items) {
			container.innerHTML = '';
			if (!items || items.length === 0) {
				container.innerHTML = '<div class="text-muted p-3">Nessun elemento</div>';
				return;
			}
			for (const it of items) {
				const row = document.createElement('label');
				row.className = 'list-group-item d-flex justify-content-between align-items-center';
				row.innerHTML = `
					<div class="form-check">
						<input class="form-check-input me-2" type="checkbox" value="${it.id}" data-type="${it.type}">
						<span class="fw-semibold">${it.name}</span>
						<small class="text-muted ms-2">${it.uploader || ''}</small>
					</div>
					<small class="text-muted">${(it.uploaded_at || '').replace('T',' ').slice(0,16)}</small>
				`;
				container.appendChild(row);
			}
		}

		async function loadUnassigned() {
			const resp = await fetch(`${window.location.pathname}/unassigned`);
			if (!resp.ok) return;
			const data = await resp.json();
			renderItems(excelList, data.excel);
			renderItems(textList, data.texts);
		}

		btnOpen?.addEventListener('click', async () => {
			await loadUnassigned();
			const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
			modal.show();
		});

		btnConfirm?.addEventListener('click', async () => {
			const checked = modalEl.querySelectorAll('input[type="checkbox"]:checked');
			const excelIds = [];
			const textIds = [];
			checked.forEach(cb => {
				(cb.dataset.type === 'excel' ? excelIds : textIds).push(parseInt(cb.value));
			});
			if (excelIds.length === 0 && textIds.length === 0) {
				alert('Seleziona almeno un elemento.');
				return;
			}
			try {
				const res = await fetch(`${window.location.pathname}/assign`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': csrf
					},
					body: JSON.stringify({ excel_ids: excelIds, text_ids: textIds })
				});
				if (!res.ok) throw new Error('Errore di rete');
				const out = await res.json();
				if (out.success) {
					// ricarica pagina mantenendo filtri
					const params = new URLSearchParams(window.location.search);
					window.location.href = `${window.location.pathname}?${params.toString()}`;
				} else {
					alert(out.error || 'Errore durante l\'assegnazione');
				}
			} catch (e) {
				alert('Errore durante l\'assegnazione: ' + e.message);
			}
		});
	})();
</script>
{% endif %}

{% endblock %}
