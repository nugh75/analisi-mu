{% extends "base.html" %}

{% block title %}File - {{ project.name }}{% endblock %}

{% block content %}
<div class="row mb-3">
	<div class="col-12 d-flex justify-content-between align-items-center">
		<div>
			<h2><i class="bi bi-files me-2"></i>File di {{ project.name }}</h2>
			<p class="text-muted mb-0">Vista unificata di file Excel e Documenti di Testo</p>
		</div>
			<div class="btn-group">
				{% if project.can_edit(current_user) %}
				<a href="{{ url_for('projects.assign_files', project_id=project.id) }}" class="btn btn-primary">
					<i class="bi bi-plus-circle me-1"></i>Assegna File
				</a>
				{% endif %}
			<a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn btn-outline-secondary">
				<i class="bi bi-speedometer2 me-1"></i>Dashboard
			</a>
			<a href="{{ url_for('projects.project_notes', project_id=project.id) }}" class="btn btn-outline-secondary">
				<i class="bi bi-sticky me-1"></i>Note
			</a>
			<a href="{{ url_for('projects.manage_collaborators', project_id=project.id) }}" class="btn btn-outline-secondary">
				<i class="bi bi-people me-1"></i>Collaboratori
			</a>
			{% if project.can_manage(current_user) %}
			<a href="{{ url_for('projects.project_settings', project_id=project.id) }}" class="btn btn-outline-warning">
				<i class="bi bi-gear me-1"></i>Impostazioni
			</a>
			{% endif %}
		</div>
	</div>
</div>

<!-- Filtri -->
<form method="get" class="row g-3 mb-3">
	<div class="col-md-3">
		<label class="form-label">Tipo</label>
		<select class="form-select" name="type">
			<option value="all" {{ 'selected' if file_type=='all' else '' }}>Tutti</option>
			<option value="excel" {{ 'selected' if file_type=='excel' else '' }}>Excel</option>
			<option value="text" {{ 'selected' if file_type=='text' else '' }}>Testo</option>
		</select>
	</div>
	<div class="col-md-3">
		<label class="form-label">Ordina per</label>
		<select class="form-select" name="sort">
			<option value="date" {{ 'selected' if sort_by=='date' else '' }}>Data</option>
			<option value="name" {{ 'selected' if sort_by=='name' else '' }}>Nome</option>
			<option value="annotations" {{ 'selected' if sort_by=='annotations' else '' }}>Annotazioni</option>
		</select>
	</div>
	<div class="col-md-3 d-flex align-items-end">
		<button type="submit" class="btn btn-primary w-100"><i class="bi bi-search me-1"></i>Applica</button>
	</div>
</form>

{% if files.items %}
<div class="table-responsive">
	<table class="table table-hover align-middle">
		<thead>
			<tr>
				<th style="width:40px;"></th>
				<th>Nome</th>
				<th>Tipo</th>
				<th>Annotazioni</th>
				<th>Elementi</th>
				<th>Caricato da</th>
				<th>Data</th>
				<th>Azioni</th>
			</tr>
		</thead>
		<tbody>
			{% for f in files.items %}
			<tr>
				<td class="text-center">
					{% if f.type == 'excel' %}
					<i class="bi bi-file-earmark-excel text-success"></i>
					{% else %}
					<i class="bi bi-file-text text-primary"></i>
					{% endif %}
				</td>
				<td>{{ f.name }}</td>
				<td class="text-capitalize">{{ f.type }}</td>
				<td>{{ f.annotations_count }}</td>
				<td>{{ f.cells_count }}</td>
				<td>{{ f.uploader }}</td>
				<td>
					{% if f.uploaded_at %}
					<small class="text-muted">{{ f.uploaded_at.strftime('%d/%m/%Y %H:%M') }}</small>
					{% endif %}
				</td>
				<td>
					{% if f.type == 'excel' %}
					<a href="{{ url_for('excel.view_file', file_id=f.id) }}" class="btn btn-sm btn-outline-primary">
						<i class="bi bi-eye me-1"></i>Apri
					</a>
					{% else %}
					<a href="{{ url_for('text_documents.annotate', document_id=f.id) }}" class="btn btn-sm btn-outline-primary">
						<i class="bi bi-eye me-1"></i>Apri
					</a>
					{% endif %}
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
</div>

<!-- Paginazione -->
{% if files.pages > 1 %}
<nav aria-label="Paginazione" class="mt-3">
	<ul class="pagination justify-content-center">
		{% if files.has_prev %}
		<li class="page-item">
			<a class="page-link" href="{{ url_for('projects.project_files', project_id=project.id, page=files.prev_num, type=file_type, sort=sort_by) }}">
				<i class="bi bi-chevron-left"></i>
			</a>
		</li>
		{% endif %}

		{% for p in range(1, files.pages + 1) %}
		<li class="page-item {{ 'active' if p == files.page else '' }}">
			<a class="page-link" href="{{ url_for('projects.project_files', project_id=project.id, page=p, type=file_type, sort=sort_by) }}">{{ p }}</a>
		</li>
		{% endfor %}

		{% if files.has_next %}
		<li class="page-item">
			<a class="page-link" href="{{ url_for('projects.project_files', project_id=project.id, page=files.next_num, type=file_type, sort=sort_by) }}">
				<i class="bi bi-chevron-right"></i>
			</a>
		</li>
		{% endif %}
	</ul>
	<div class="text-center text-muted small">Totale: {{ files.total }}</div>
 </nav>
{% endif %}

{% else %}
<div class="text-center py-5">
	<i class="bi bi-folder2-open display-1 text-muted mb-3"></i>
	<h5 class="text-muted">Nessun file</h5>
	<p class="text-muted">Carica file Excel o documenti di testo in questo progetto.</p>
</div>
{% endif %}

{% endblock %}
